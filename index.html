<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>GeoBase</title>
</head>
<body>

<div>
    <select required name="country" onchange="loadJson('region',this)">
        <option>Загрузка...</option>
    </select>

    <select class="element select medium" required id="element_21" name="region" disabled="disabled"
            onchange="loadJson('city',this)">
        <option>Выберите страну</option>
    </select>

    <select class="element select medium" required id="element_22" name="city" disabled="disabled">
        <option>Выберите регион</option>
    </select>
</div>

<script type="text/javascript">
	function loadJson(action, select = false) {

		let element = document.querySelector(`select[name=${action}]`);
		let city = document.querySelector("select[name='city']");

		element.setAttribute('disabled', 'disabled'); // делаем список городов не активным

		if (action === 'region') city.setAttribute('disabled', 'disabled'); // если функция запрашивает регионы,

		let value = select.value;

		fetch(`api.php?action=${action}&id=${value}`) // отправляем
			.then((response) => {
				return response.json();
			})
			.then((dataList) => {
				removeChild(element);
				//element.html(''); // очищаем список текущих елементов
				if (action === 'region') {
					removeChild(city);
					//city.html('');
					city.insertAdjacentHTML("beforeend", '<option value="">Выберите регион</option>');
				}
				changeHTML(element, dataList);
			});
		return true;
	}

	function changeHTML(element, dataList) {
		console.log(dataList.status)
		console.log(dataList.data)
		if (dataList.status === false) { // если подключения нет
			let country = document.querySelector("select[name='country']");
			removeChild(country);
			country.insertAdjacentHTML("beforeend", '<option value="">Укажите подключение к базе данных</option>');
		} else if (dataList.data === false) { // если нет подходящих данных в DB
			element.insertAdjacentHTML("beforeend", '<option value="">Нет данных</option>');
			element.attr('disabled', 'disabled');
		}
		// заполняем список новыми пришедшими данными
		else {
			element.insertAdjacentHTML("beforeend", '<option value="">Выбрать</option>');
			dataList.data.map(function(item) {
				element.insertAdjacentHTML("beforeend", '<option value="' + item.id + '">' + item.name + '</option>');
			});
			element.removeAttribute('disabled'); // делаем список городов активным
		}
	}

	function removeChild(element) {
		while (element.firstChild) {
			element.removeChild(element.firstChild);
		}
	}

	loadJson('country'); // загрузка стран

</script>
</body>
</html>